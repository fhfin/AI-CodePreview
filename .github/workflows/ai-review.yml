name: Custom AI Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç  (è™½ç„¶æˆ‘ä»¬ä¸»è¦ç”¨ API æ‹¿ Diffï¼Œä½†æ£€å‡ºæ˜¯ä¸ªå¥½ä¹ æƒ¯)
      - uses: actions/checkout@v4

      # 2. å®‰è£… Node ç¯å¢ƒ
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. å®‰è£…ä¾èµ– (OpenAI SDK)
      - name: Install Dependencies
        run: npm install openai

      # 4. æ‰§è¡Œæ ¸å¿ƒè„šæœ¬
      - name: Run AI Review
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const OpenAI = require('openai');
            
            // åˆå§‹åŒ– OpenAI
            const openai = new OpenAI({
              apiKey: process.env.OPENAI_API_KEY
            });

            // è·å– PR ä¿¡æ¯
            const { owner, repo } = context.repo;
            const pull_number = context.issue.number;

            // 1. è·å– Diff
            // GitHub API å¯ä»¥ç›´æ¥è¿”å› diff æ ¼å¼
            const { data: diffData } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number,
              mediaType: {
                format: "diff",
              },
            });

            if (!diffData) {
              console.log('No diff found');
              return;
            }

            // ç®€å•æˆªæ–­é˜²æ­¢ Token æº¢å‡º (ç”Ÿäº§ç¯å¢ƒå»ºè®®æŒ‰æ–‡ä»¶æ‹†åˆ†)
            const diffContent = diffData.substring(0, 15000);

            // 2. æ„é€  Prompt
            const prompt = `
            ä½ æ˜¯ä¸€ä¸ªèµ„æ·±ä»£ç è¯„å®¡å‘˜ã€‚è¯·æ£€æŸ¥ä»¥ä¸‹ Git Diffã€‚
            é‡ç‚¹å…³æ³¨ï¼šBugã€å®‰å…¨æ¼æ´ã€TypeScript ç±»å‹é”™è¯¯ã€‚
            è¯·ç”¨ Markdown æ ¼å¼åˆ—å‡ºé—®é¢˜ã€‚å¦‚æœä»£ç å®Œç¾ï¼Œè¯·å›å¤ "LGTM ğŸ‘"ã€‚
            
            Diff:
            ${diffContent}
            `;

            console.log('ğŸ¤– Asking AI...');

            // 3. è°ƒç”¨ AI
            try {
              const completion = await openai.chat.completions.create({
                messages: [{ role: "user", content: prompt }],
                model: "gpt-4-turbo",
              });

              const reviewComment = completion.choices[0].message.content;

              // 4. æäº¤è¯„è®ºåˆ° PR
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: `## ğŸ¤– Custom AI Review\n\n${reviewComment}`
              });

            } catch (error) {
              console.error('Error calling OpenAI:', error);
              core.setFailed(error.message);
            }